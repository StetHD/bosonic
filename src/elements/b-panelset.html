<element name="b-panelset">
    <style>
        b-panelset {
            display: block;
            border: 1px solid transparent;
            border-color: var(--b-panel-border);
            border-radius: var(--b-panel-border-radius);
            box-shadow: var(--b-panel-shadow);
        }
        b-panelset > b-panel {
            border: none;
        }
        b-panelset[preferreddisplay='tabs'] {
            
        }
        b-panelset[preferreddisplay='tabs'] > b-panel {
            
        }
        b-panel:not(:first-child) {
            border-radius: 0;
        }
    </style>
    <script>
        (function(){
            Bosonic.register({
                mixins: [Bosonic.Transitions],

                get tabBar() {
                    return this.querySelector('b-panel-tabs');
                },

                get selectedIndex() {
                    return this._selectedIndex;
                },

                set selectedIndex(value) {
                    this._selectedIndex = this._registeredPanels[value] !== undefined ? value : 0;
                    this._registeredPanels.forEach(function(panel, i) {
                        panel.open = (i === this._selectedIndex) ? true : false;
                    }, this);
                },

                get activePanelElement() {
                    return this._registeredPanels[this.selectedIndex] || null;
                },

                createdCallback: function() {
                    this._selectedIndex = -1;
                    this._registeredPanels = [];
                    var tabBar = document.createElement('b-panel-tabs');
                    this.insertBefore(tabBar, this.firstChild || null);
                },

                registerPanel: function(panel) {
                    var index = this._registeredPanels.push(panel) - 1,
                        title = panel.querySelector('b-panel-title'),
                        tab = title.cloneNode(true);

                    tab.tabIndex = -1;
                    tab.panelElement = panel;
                    tab.setAttribute('aria-controls', panel.contentElement.id);
                    tab.setAttribute('aria-selected', 'false');
                    this.tabBar.appendChild(tab);
                    
                    panel.open = false;
                    if (panel.hasAttribute('open') || index == 0) {
                        this.selectedIndex = index;
                    }
                    
                    this.listen(title, 'tap', 'handleTitleTap');
                    this.listen(tab, 'tap', 'handleTabTap');
                },

                selectPanel: function(index) {
                    var active = this.activePanelElement,
                        panel = this._registeredPanels[index];

                    this._selectedIndex = index;

                    if (!this.hasAttribute('exit-transition')) {
                        active.open = false;
                    } else {
                        this.playTransition('exit', active.contentWrapper).end(function() {console.log('end exit')
                            active.open = false;
                        }.bind(this));
                    }
                    panel.open = true;
                    if (this.hasAttribute('entry-transition')) {console.log('begin entry')
                                
                                this.playTransition('entry', panel.contentWrapper).end(function() {console.log('end entry')
                                    
                                });
                            }
                    
                },

                handleTitleTap: function(e) {
                    var panelIndex =  this._registeredPanels.indexOf(e.target.parentNode);
                    if (panelIndex !== -1) {
                        this.selectPanel(panelIndex);
                    }
                },

                handleTabTap: function(e) {
                    var panelIndex =  this._registeredPanels.indexOf(e.target.panelElement);
                    if (panelIndex !== -1) {
                        this.selectPanel(panelIndex);
                    }
                }
            });
        })();
    </script>
</element>

<element name="b-panel-tabs" attributes="selected">
    <style>
        b-panel-tabs {
            display: block;
            /*background-color: var(--b-tabs-bg-color);*/
            border-bottom: var(--b-tabs-border-bottom);
            box-shadow: var(--b-tabs-shadow);
        }
        b-panelset:not([preferreddisplay='tabs']) b-panel-tabs {
            display: none;
        }
        b-panelset[preferreddisplay='tabs'] > b-panel {
            border-top: none;
        }
        b-panelset[preferreddisplay='tabs'] > b-panel > b-panel-title {
            display: none;
        }
        b-panel-tabs > b-panel-title {
            display: inline-block;
            font-size: 1.1em; /* must be > 1 so that b-panel-tabs bottom border stays visible... */
            cursor: default;
            padding: var(--b-tab-padding);
            border-bottom: 3px solid transparent;
            color: var(--b-tab-inactive-color);
            background-color: white;
            box-shadow: none;
        }
        b-panel-tabs > b-panel-title.active {
            border-bottom-color: var(--b-tab-bar-color);
            font-weight: var(--b-tab-active-font-weight);
            color: var(--b-tab-active-color);
        }
    </style>
    <script>
        (function(){
            Bosonic.register({});
        })();
    </script>
</element>
<element name="b-panel-tab">
    <style>
        b-panel-tab {
            display: inline-block;
            cursor: default;
            padding: var(--b-tab-padding);
            border-bottom: 3px solid transparent;
            color: var(--b-tab-inactive-color);
        }
        b-panel-tab.active {
            border-bottom-color: var(--b-tab-bar-color);
            font-weight: var(--b-tab-active-font-weight);
            color: var(--b-tab-active-color);
        }
    </style>
    <script>
        (function(){
            Bosonic.register({
                hasFocus: function() {
                    return this === document.activeElement;
                }
            });
        })();
    </script>
</element>